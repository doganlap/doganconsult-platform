@page "/"
@using DoganConsult.Web.Blazor.Services
@using Microsoft.AspNetCore.Components.Authorization
@inherits WebComponentBase

<PageTitle>DC OS - @L["Dashboard"]</PageTitle>

<div class="dashboard-container">
    <!-- 3-Zone Header: Brand | Search | User/Language/AI -->
    <div class="dc-header-3zone mb-4">
        <div class="dc-header-zone-left">
            <div class="d-flex align-items-center gap-3">
                <img src="/images/logo/dc-os-logo.svg" alt="DG.OS" height="32" class="dc-logo" />
                <div class="dc-brand-context">
                    <h6 class="mb-0 fw-bold">DG.OS</h6>
                    <small class="text-muted">@CurrentUserTitle</small>
                </div>
            </div>
        </div>
        
        <div class="dc-header-zone-center">
            <div class="dc-global-search">
                <input type="text" class="form-control form-control-sm" placeholder="Search documents, workspaces, users..." 
                       @bind="SearchQuery" @onkeypress="HandleGlobalSearch" />
                <i class="fas fa-search dc-search-icon"></i>
            </div>
        </div>
        
        <div class="dc-header-zone-right">
            <div class="d-flex align-items-center gap-2">
                <LanguageSwitcher />
                <button class="btn btn-sm btn-outline-secondary dc-ai-quick-btn" @onclick="OpenAIAssistant" title="AI Assistant">
                    <i class="fas fa-brain"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Welcome Card with Next Action -->
    <div class="card dc-welcome-card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="mb-1">Welcome back, @CurrentUserName</h5>
                    <p class="mb-0 text-muted">
                        @if (Summary.PendingApprovals > 0)
                        {
                            <span>You have <strong>@Summary.PendingApprovals approval@(Summary.PendingApprovals != 1 ? "s" : "")</strong> pending</span>
                        }
                        else
                        {
                            <span>All caught up! Ready to create your next workspace.</span>
                        }
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-sm btn-primary" @onclick='() => NavigateTo("/workspaces")'>
                        <i class="fas fa-plus me-1"></i>Create Workspace
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Executive Summary Row -->
    <div class="dc-executive-summary mb-4">
        <div class="row g-3">
            <!-- Operational Section -->
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm dc-summary-section">
                    <div class="card-body">
                        <h6 class="card-title text-uppercase fw-bold text-muted mb-3">
                            <i class="fas fa-layer-group text-primary me-2"></i>Operational
                        </h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/workspaces")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">@Summary.TotalWorkspaces</div>
                                    <div class="dc-kpi-label">Workspaces</div>
                                    <div class="dc-kpi-trend">â€” No data yet</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/documents")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">@Summary.TotalDocuments</div>
                                    <div class="dc-kpi-label">Documents</div>
                                    <div class="dc-kpi-trend">â€” No data yet</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Governance Section -->
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm dc-summary-section">
                    <div class="card-body">
                        <h6 class="card-title text-uppercase fw-bold text-muted mb-3">
                            <i class="fas fa-shield-alt text-success me-2"></i>Governance
                        </h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="dc-kpi-item @(Summary.PendingApprovals > 0 ? "dc-kpi-alert" : "")" @onclick='() => NavigateTo("/approvals")' style="cursor: pointer;">
                                    <div class="dc-kpi-value @(Summary.PendingApprovals > 0 ? "text-warning" : "")">@Summary.PendingApprovals</div>
                                    <div class="dc-kpi-label">Open Approvals</div>
                                    <div class="dc-kpi-trend">@(Summary.PendingApprovals > 0 ? "âš  Action needed" : "â€” All clear")</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/audit-logs")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">0</div>
                                    <div class="dc-kpi-label">Audit Events (7d)</div>
                                    <div class="dc-kpi-trend">â€” Last 7 days</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Section -->
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm dc-summary-section">
                    <div class="card-body">
                        <h6 class="card-title text-uppercase fw-bold text-muted mb-3">
                            <i class="fas fa-brain text-info me-2"></i>AI Engine
                        </h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/ai-chat")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">0</div>
                                    <div class="dc-kpi-label">Automations Run</div>
                                    <div class="dc-kpi-trend">â€” This period</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/ai-chat")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">0</div>
                                    <div class="dc-kpi-label">Recommendations</div>
                                    <div class="dc-kpi-trend">â€” Generated</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Organization Section -->
            <div class="col-md-6">
                <div class="card h-100 border-0 shadow-sm dc-summary-section">
                    <div class="card-body">
                        <h6 class="card-title text-uppercase fw-bold text-muted mb-3">
                            <i class="fas fa-building text-success me-2"></i>Organization
                        </h6>
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/organizations")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">@Summary.TotalOrganizations</div>
                                    <div class="dc-kpi-label">Organizations</div>
                                    <div class="dc-kpi-trend">â€” Active</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="dc-kpi-item" @onclick='() => NavigateTo("/user-profiles")' style="cursor: pointer;">
                                    <div class="dc-kpi-value">@Summary.TotalUsers</div>
                                    <div class="dc-kpi-label">Users</div>
                                    <div class="dc-kpi-trend">â€” Registered</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Tabs -->
    <div class="card mb-4">
        <div class="card-header bg-white border-bottom-0">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "overview" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("overview"))">
                        <i class="fas fa-chart-pie me-2"></i>Overview
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "analytics" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("analytics"))">
                        <i class="fas fa-chart-line me-2"></i>Analytics
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "pivot" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("pivot"))">
                        <i class="fas fa-table me-2"></i>Pivot Analysis
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "guidance" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("guidance"))">
                        <i class="fas fa-compass me-2"></i>Role Guidance
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "knowledge" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("knowledge"))">
                        <i class="fas fa-book me-2"></i>Knowledge Base
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "activity" ? "active" : "")" 
                            @onclick="@(() => SwitchTab("activity"))">
                        <i class="fas fa-history me-2"></i>Activity
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            @switch (ActiveTab)
            {
                case "overview":
                    @RenderOverviewTab()
                    break;
                case "analytics":
                    @RenderAnalyticsTab()
                    break;
                case "pivot":
                    @RenderPivotTab()
                    break;
                case "guidance":
                    @RenderGuidanceTab()
                    break;
                case "knowledge":
                    @RenderKnowledgeTab()
                    break;
                case "activity":
                    @RenderActivityTab()
                    break;
            }
        </div>
    </div>

    <!-- AI Recommendations Panel -->
    @if (AIResponse.Recommendations.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-lightbulb text-warning me-2"></i>AI Recommendations</h5>
                <button class="btn btn-sm btn-outline-primary" @onclick="RefreshRecommendations">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    @foreach (var rec in AIResponse.Recommendations)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 recommendation-card @GetPriorityClass(rec.Priority)">
                                <div class="card-body">
                                    <div class="d-flex align-items-start mb-2">
                                        <span class="badge @GetPriorityBadgeClass(rec.Priority) me-2">@rec.Priority</span>
                                        <h6 class="mb-0">@rec.Title</h6>
                                    </div>
                                    <p class="text-muted small mb-3">@rec.Description</p>
                                    <button class="btn btn-sm btn-primary" @onclick="() => NavigateTo(rec.Route)">
                                        @rec.Action <i class="fas fa-arrow-right ms-1"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- DC OS AI Agent Chat Panel -->
@if (ShowAIAssistant)
{
    <div class="dc-ai-panel @(IsAIChatMinimized ? "minimized" : "")">
        <div class="dc-ai-header">
            <div class="d-flex align-items-center">
                <div class="dc-ai-avatar me-2">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-white">DC OS AI Agent</h6>
                    <small class="text-white-50">Personalized for @CurrentUserName (@CurrentUserRole)</small>
                </div>
            </div>
            <div class="dc-ai-controls">
                <button class="btn btn-sm btn-link text-white" @onclick="ToggleAIMinimize" title="@(IsAIChatMinimized ? "Expand" : "Minimize")">
                    <i class="fas @(IsAIChatMinimized ? "fa-expand" : "fa-minus")"></i>
                </button>
                <button class="btn btn-sm btn-link text-white" @onclick="CloseAIAssistant" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        @if (!IsAIChatMinimized)
        {
            <div class="dc-ai-body">
                <div class="dc-ai-context mb-3">
                    <small class="text-muted">
                        <i class="fas fa-user-circle me-1"></i>@CurrentUserName
                        <span class="mx-2">|</span>
                        <i class="fas fa-briefcase me-1"></i>@CurrentUserTitle
                        <span class="mx-2">|</span>
                        <i class="fas fa-shield-alt me-1"></i>@CurrentUserRole
                    </small>
                </div>
                <div class="dc-ai-messages">
                    @foreach (var msg in ChatMessages)
                    {
                        <div class="dc-chat-message @(msg.IsUser ? "user" : "ai")">
                            <div class="dc-message-avatar">
                                @if (msg.IsUser)
                                {
                                    <span>@GetUserInitials()</span>
                                }
                                else
                                {
                                    <i class="fas fa-brain"></i>
                                }
                            </div>
                            <div class="dc-message-content">
                                <div class="dc-message-header">
                                    <strong>@(msg.IsUser ? CurrentUserName : "DC AI Agent")</strong>
                                    <small class="text-muted">@msg.Timestamp.ToString("HH:mm")</small>
                                </div>
                                <div class="dc-message-text">@msg.Content</div>
                            </div>
                        </div>
                    }
                    @if (IsSendingMessage)
                    {
                        <div class="dc-chat-message ai">
                            <div class="dc-message-avatar"><i class="fas fa-brain"></i></div>
                            <div class="dc-message-content">
                                <div class="dc-typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div class="dc-ai-footer">
                <div class="dc-quick-actions mb-2">
                    <button class="btn btn-sm btn-outline-secondary" @onclick='() => QuickAsk("What are my pending tasks?")'>ðŸ“‹ Tasks</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick='() => QuickAsk("Show my approvals")'>âœ… Approvals</button>
                    <button class="btn btn-sm btn-outline-secondary" @onclick='() => QuickAsk("Help me get started")'>ðŸš€ Help</button>
                </div>
                <div class="dc-ai-input">
                    <input type="text" class="form-control" placeholder="Ask your AI agent..." 
                           @bind="UserMessage" @onkeypress="HandleChatKeyPress" />
                    <button class="dc-send-btn" @onclick="SendMessage" disabled="@IsSendingMessage">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    private string SearchQuery = "";
    
    private void HandleGlobalSearch(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(SearchQuery))
        {
            // Implement global search logic
            NavigateTo("/search?q=" + Uri.EscapeDataString(SearchQuery));
        }
    }
    
    // Render methods for each tab
    private RenderFragment RenderOverviewTab() => __builder =>
    {
        <div class="row">
            <!-- Quick Actions (Left Column) -->
            <div class="col-lg-8 mb-4">
                <h5 class="mb-3"><i class="fas fa-zap text-warning me-2"></i>Quick Actions</h5>
                <div class="row g-2">
                    <div class="col-6 col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3 dc-quick-action-btn" @onclick='() => NavigateTo("/workspaces")'>
                            <i class="fas fa-plus-circle fa-lg d-block mb-2"></i>
                            <small>Create Workspace</small>
                        </button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3 dc-quick-action-btn" @onclick='() => NavigateTo("/documents")'>
                            <i class="fas fa-file-upload fa-lg d-block mb-2"></i>
                            <small>Upload Document</small>
                        </button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3 dc-quick-action-btn" @onclick='() => NavigateTo("/ai-chat")'>
                            <i class="fas fa-brain fa-lg d-block mb-2"></i>
                            <small>Start AI Review</small>
                        </button>
                    </div>
                    <div class="col-6 col-md-3">
                        <button class="btn btn-outline-primary w-100 py-3 dc-quick-action-btn" @onclick='() => NavigateTo("/approvals")'>
                            <i class="fas fa-check-circle fa-lg d-block mb-2"></i>
                            <small>Request Approval</small>
                        </button>
                    </div>
                </div>
            </div>

            <!-- System Health (Right Column) -->
            <div class="col-lg-4 mb-4">
                <h5 class="mb-3"><i class="fas fa-heartbeat text-success me-2"></i>System Health</h5>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">Overall Health</span>
                            <span class="badge bg-success">@Summary.SystemHealthScore%</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: @Summary.SystemHealthScore%"></div>
                        </div>
                        <small class="text-muted d-block mb-3">Last checked: 2 min ago</small>
                        <button class="btn btn-sm btn-link p-0 text-primary">View details â†’</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Insights Panel (Right Side) -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <!-- Placeholder for additional content -->
            </div>
            <div class="col-lg-4 mb-4">
                <h5 class="mb-3"><i class="fas fa-lightbulb text-warning me-2"></i>AI Insights</h5>
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="small fw-bold mb-2">Suggested Next Steps</h6>
                            <ul class="list-unstyled small">
                                <li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>Review pending approvals</li>
                                <li class="mb-2"><i class="fas fa-arrow-right text-primary me-2"></i>Create new workspace</li>
                                <li><i class="fas fa-arrow-right text-primary me-2"></i>Upload documents</li>
                            </ul>
                        </div>
                        <hr class="my-2" />
                        <div class="mb-3">
                            <h6 class="small fw-bold mb-2">Risks & Anomalies</h6>
                            <p class="small text-muted mb-0">No anomalies detected. System operating normally.</p>
                        </div>
                        <hr class="my-2" />
                        <div>
                            <h6 class="small fw-bold mb-2">Pending Items</h6>
                            <div class="small">
                                <span class="badge bg-warning text-dark">@Summary.PendingApprovals Approvals</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment RenderAnalyticsTab() => __builder =>
    {
        <div class="row mb-4">
            <!-- Filters -->
            <div class="col-12 mb-3">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0 fw-bold">Filters:</label>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="SelectedTimeRange">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 90 Days</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="SelectedChartType">
                                    <option value="line">Line Chart</option>
                                    <option value="bar">Bar Chart</option>
                                    <option value="area">Area Chart</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="SelectedMetric">
                                    <option value="all">All Metrics</option>
                                    <option value="organizations">Organizations</option>
                                    <option value="documents">Documents</option>
                                    <option value="approvals">Approvals</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-primary" @onclick="RefreshCharts">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="col-auto ms-auto">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="ExportChartData">
                                    <i class="fas fa-download me-1"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Chart 1: Trend Analysis -->
            <div class="col-lg-8 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Trend Analysis</h6>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary active">Daily</button>
                            <button class="btn btn-outline-secondary">Weekly</button>
                            <button class="btn btn-outline-secondary">Monthly</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px;">
                            <!-- SVG Chart -->
                            <svg width="100%" height="100%" viewBox="0 0 600 280">
                                <!-- Grid lines -->
                                @for (int i = 0; i <= 4; i++)
                                {
                                    <line x1="50" y1="@(50 + i * 50)" x2="580" y2="@(50 + i * 50)" 
                                          stroke="#e0e0e0" stroke-dasharray="5,5" />
                                    @((MarkupString)$"<text x=\"40\" y=\"{55 + i * 50}\" text-anchor=\"end\" font-size=\"12\" fill=\"#666\">{(4-i) * 25}</text>")
                                }
                                
                                <!-- Chart line -->
                                <polyline fill="none" stroke="#0d6efd" stroke-width="2"
                                          points="@GetChartPoints(OrganizationTrends)" />
                                
                                <!-- Data points -->
                                @{ int idx = 0; }
                                @foreach (var point in OrganizationTrends.TakeLast(10))
                                {
                                    var x = 80 + idx * 50;
                                    var y = 250 - (point.Value / 50.0 * 200);
                                    var labelText = point.Label.Length >= 3 ? point.Label.Substring(0, 3) : point.Label;
                                    <circle cx="@x" cy="@y" r="4" fill="#0d6efd" />
                                    @((MarkupString)$"<text x=\"{x}\" y=\"270\" text-anchor=\"middle\" font-size=\"10\" fill=\"#666\">{labelText}</text>")
                                    idx++;
                                }
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart 2: Distribution -->
            <div class="col-lg-4 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h6 class="mb-0">Distribution</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-container text-center" style="height: 200px;">
                            <!-- Donut Chart -->
                            <svg width="180" height="180" viewBox="0 0 180 180">
                                <circle cx="90" cy="90" r="70" fill="none" stroke="#0d6efd" stroke-width="20"
                                        stroke-dasharray="110 330" transform="rotate(-90 90 90)" />
                                <circle cx="90" cy="90" r="70" fill="none" stroke="#198754" stroke-width="20"
                                        stroke-dasharray="88 352" stroke-dashoffset="-110" transform="rotate(-90 90 90)" />
                                <circle cx="90" cy="90" r="70" fill="none" stroke="#ffc107" stroke-width="20"
                                        stroke-dasharray="66 374" stroke-dashoffset="-198" transform="rotate(-90 90 90)" />
                                <circle cx="90" cy="90" r="70" fill="none" stroke="#6c757d" stroke-width="20"
                                        stroke-dasharray="176 264" stroke-dashoffset="-264" transform="rotate(-90 90 90)" />
                                <text x="90" y="95" text-anchor="middle" font-size="24" font-weight="bold">100%</text>
                            </svg>
                        </div>
                        <div class="mt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="fas fa-circle text-primary me-2"></i>Organizations</span>
                                <strong>25%</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="fas fa-circle text-success me-2"></i>Documents</span>
                                <strong>20%</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span><i class="fas fa-circle text-warning me-2"></i>Approvals</span>
                                <strong>15%</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span><i class="fas fa-circle text-secondary me-2"></i>Other</span>
                                <strong>40%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment RenderPivotTab() => __builder =>
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body py-3">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0 fw-bold">Pivot Configuration:</label>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="PivotRowField">
                                    <option value="organization">Organization</option>
                                    <option value="department">Department</option>
                                    <option value="user">User</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="PivotColumnField">
                                    <option value="status">Status</option>
                                    <option value="type">Type</option>
                                    <option value="priority">Priority</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select form-select-sm" @bind="PivotAggregation">
                                    <option value="count">Count</option>
                                    <option value="sum">Sum</option>
                                    <option value="avg">Average</option>
                                </select>
                            </div>
                            <div class="col-auto">
                                <button class="btn btn-sm btn-primary" @onclick="RefreshPivotData">
                                    <i class="fas fa-sync-alt me-1"></i>Apply
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-hover pivot-table">
                <thead class="table-dark">
                    <tr>
                        <th class="sortable" style="cursor: pointer;" @onclick='() => SortPivot("row")'>
                            @PivotRowField.ToUpper()
                            @if (PivotSortField == "row")
                            {
                                <i class="fas fa-sort-@(PivotSortAsc ? "up" : "down") ms-1"></i>
                            }
                        </th>
                        <th class="text-center sortable" style="cursor: pointer;" @onclick='() => SortPivot("pending")'>
                            Pending
                            @if (PivotSortField == "pending")
                            {
                                <i class="fas fa-sort-@(PivotSortAsc ? "up" : "down") ms-1"></i>
                            }
                        </th>
                        <th class="text-center sortable" style="cursor: pointer;" @onclick='() => SortPivot("approved")'>
                            Approved
                            @if (PivotSortField == "approved")
                            {
                                <i class="fas fa-sort-@(PivotSortAsc ? "up" : "down") ms-1"></i>
                            }
                        </th>
                        <th class="text-center sortable" style="cursor: pointer;" @onclick='() => SortPivot("rejected")'>
                            Rejected
                            @if (PivotSortField == "rejected")
                            {
                                <i class="fas fa-sort-@(PivotSortAsc ? "up" : "down") ms-1"></i>
                            }
                        </th>
                        <th class="text-center bg-secondary text-white">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in GetPivotRows())
                    {
                        var pending = GetPivotValue(row, "Pending");
                        var approved = GetPivotValue(row, "Approved");
                        var rejected = GetPivotValue(row, "Rejected");
                        var total = pending + approved + rejected;
                        <tr>
                            <td class="fw-bold">@row</td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark">@pending</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-success">@approved</span>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-danger">@rejected</span>
                            </td>
                            <td class="text-center bg-light fw-bold">@total</td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th>Grand Total</th>
                        <th class="text-center">@PivotData.Where(x => x.Column == "Pending").Sum(x => x.Value)</th>
                        <th class="text-center">@PivotData.Where(x => x.Column == "Approved").Sum(x => x.Value)</th>
                        <th class="text-center">@PivotData.Where(x => x.Column == "Rejected").Sum(x => x.Value)</th>
                        <th class="text-center">@PivotData.Sum(x => x.Value)</th>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="mt-3 text-end">
            <button class="btn btn-outline-primary me-2" @onclick="ExportPivotToCsv">
                <i class="fas fa-file-csv me-1"></i>Export CSV
            </button>
            <button class="btn btn-outline-success" @onclick="ExportPivotToExcel">
                <i class="fas fa-file-excel me-1"></i>Export Excel
            </button>
        </div>
    };

    private RenderFragment RenderGuidanceTab() => __builder =>
    {
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card text-white h-100" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="card-body">
                        <h4 class="card-title">
                            <i class="fas fa-user-shield me-2"></i>@RoleGuidance.Role
                        </h4>
                        <p class="card-text opacity-75">@RoleGuidance.Description</p>
                        <hr class="bg-white opacity-25" />
                        <h6>Your Responsibilities:</h6>
                        <ul class="list-unstyled">
                            @foreach (var resp in RoleGuidance.Responsibilities)
                            {
                                <li class="mb-2">
                                    <i class="fas fa-check-circle me-2"></i>@resp
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-8 mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-tasks text-primary me-2"></i>Your Quick Actions
                </h5>
                <div class="row g-3">
                    @foreach (var action in RoleGuidance.QuickActions)
                    {
                        <div class="col-md-6">
                            <div class="card quick-action-card h-100" style="cursor: pointer;" @onclick="() => NavigateTo(action.Route)">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="action-icon me-3">
                                            <i class="@action.Icon fa-2x text-primary"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-1">@action.Title</h6>
                                            <small class="text-muted">@action.Description</small>
                                        </div>
                                        <i class="fas fa-chevron-right ms-auto text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                
                <h5 class="mt-4 mb-3">
                    <i class="fas fa-graduation-cap text-success me-2"></i>How-To Guides
                </h5>
                <div class="accordion" id="howToAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#howTo1">
                                How to create an organization?
                            </button>
                        </h2>
                        <div id="howTo1" class="accordion-collapse collapse show" data-bs-parent="#howToAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Navigate to <strong>Organizations</strong> from the menu</li>
                                    <li>Click the <strong>Create New</strong> button</li>
                                    <li>Fill in the required information</li>
                                    <li>Submit for approval (if required)</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#howTo2">
                                How to submit an approval request?
                            </button>
                        </h2>
                        <div id="howTo2" class="accordion-collapse collapse" data-bs-parent="#howToAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Go to <strong>Approvals</strong> page</li>
                                    <li>Click <strong>New Request</strong></li>
                                    <li>Select the entity type and priority</li>
                                    <li>Add description and submit</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#howTo3">
                                How to manage documents?
                            </button>
                        </h2>
                        <div id="howTo3" class="accordion-collapse collapse" data-bs-parent="#howToAccordion">
                            <div class="accordion-body">
                                <ol>
                                    <li>Access the <strong>Documents</strong> section</li>
                                    <li>Use filters to find specific documents</li>
                                    <li>Click on a document to view or edit</li>
                                    <li>Use bulk actions for multiple documents</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment RenderKnowledgeTab() => __builder =>
    {
        <div class="row mb-4">
            <div class="col-12">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search knowledge base..." 
                           @bind="KnowledgeSearchQuery" @bind:event="oninput" />
                    <select class="form-select" style="max-width: 200px;" @bind="KnowledgeCategory">
                        <option value="">All Categories</option>
                        <option value="Documentation">Documentation</option>
                        <option value="Tutorial">Tutorials</option>
                        <option value="Guide">Guides</option>
                        <option value="FAQ">FAQ</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row">
            @foreach (var item in GetFilteredKnowledge())
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 knowledge-card">
                        <div class="card-body">
                            <div class="d-flex align-items-start mb-3">
                                <div class="knowledge-icon me-3">
                                    <i class="@item.Icon fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <span class="badge bg-secondary mb-2">@item.Category</span>
                                    <h5 class="card-title mb-0">@item.Title</h5>
                                </div>
                            </div>
                            <p class="card-text text-muted">
                                Learn about @item.Title.ToLower() and best practices.
                            </p>
                        </div>
                        <div class="card-footer bg-transparent border-0">
                            <a href="@item.Url" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>Read More
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Additional Resources -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5><i class="fas fa-link me-2"></i>Additional Resources</h5>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <a href="/docs/api" class="text-decoration-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-code fa-lg text-primary me-2"></i>
                                        <span>API Documentation</span>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/docs/videos" class="text-decoration-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-video fa-lg text-danger me-2"></i>
                                        <span>Video Tutorials</span>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/docs/release-notes" class="text-decoration-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clipboard-list fa-lg text-success me-2"></i>
                                        <span>Release Notes</span>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/support" class="text-decoration-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-headset fa-lg text-warning me-2"></i>
                                        <span>Support Center</span>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    };

    private RenderFragment RenderActivityTab() => __builder =>
    {
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search activities..." 
                           @bind="ActivitySearchQuery" />
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="ActivityTypeFilter">
                    <option value="">All Types</option>
                    <option value="Document">Documents</option>
                    <option value="Approval">Approvals</option>
                    <option value="Workspace">Workspaces</option>
                    <option value="Organization">Organizations</option>
                    <option value="User">Users</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button class="btn btn-outline-primary" @onclick="RefreshActivities">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>

        <div class="activity-timeline">
            @foreach (var activity in GetFilteredActivities())
            {
                <div class="activity-item d-flex mb-3 p-3 bg-light rounded">
                    <div class="activity-icon me-3">
                        <div class="icon-circle @GetActivityIconClass(activity.Type)" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                            <i class="@GetActivityIcon(activity.Type)"></i>
                        </div>
                    </div>
                    <div class="activity-content flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>@activity.User</strong>
                                <span class="text-muted">@activity.Action.ToLower()</span>
                                <span>@activity.Description</span>
                            </div>
                            <small class="text-muted">@GetTimeAgo(activity.Timestamp)</small>
                        </div>
                        <div class="mt-1">
                            <span class="badge bg-light text-dark">@activity.Type</span>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (!Activities.Any())
        {
            <div class="text-center text-muted py-5">
                <i class="fas fa-inbox fa-3x mb-3"></i>
                <p>No recent activities found</p>
            </div>
        }
    };
}
