@page "/user-profiles"
@layout PlatformLayout
@using DoganConsult.UserProfile.Permissions
@using DoganConsult.UserProfile.UserProfiles
@using DoganConsult.Web.Blazor.Services
@using Microsoft.AspNetCore.Authorization
@using Volo.Abp.Application.Dtos

<PageTitle>User Profile Management</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>User Profile Management
                        </h4>
                        @if (CanCreate)
                        {
                            <button class="btn btn-primary" @onclick="OpenCreateModal">
                                <i class="fas fa-plus me-1"></i>Add User
                            </button>
                        }
                    </div>
                </div>
                
                <div class="card-body">
                    @if (Loading)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading users...</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Name</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Role</th>
                                        <th scope="col">Stakeholder Type</th>
                                        <th scope="col">Department</th>
                                        <th scope="col">Location</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (UserProfileItems?.Any() == true)
                                    {
                                        @foreach (var user in UserProfileItems)
                                        {
                                            <tr>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(user.AvatarUrl))
                                                    {
                                                        <img src="@user.AvatarUrl" alt="@user.FullName" class="rounded-circle me-2" width="32" height="32" />
                                                    }
                                                    else
                                                    {
                                                        <span class="avatar-placeholder me-2">
                                                            <i class="fas fa-user"></i>
                                                        </span>
                                                    }
                                                    <strong>@user.FullName</strong>
                                                </td>
                                                <td>@user.Email</td>
                                                <td>
                                                    <span class="badge bg-@GetRoleColor(user.SystemRole)">
                                                        @user.SystemRole
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">
                                                        @GetStakeholderLabel(user.StakeholderType)
                                                    </span>
                                                </td>
                                                <td>@(user.Department ?? "-")</td>
                                                <td>@(user.Location ?? user.Country ?? "-")</td>
                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => ViewDetails(user)">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => EditUser(user)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteUser(user)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">
                                                <i class="fas fa-users fa-3x mb-3"></i>
                                                <p class="mb-0">No users found</p>
                                                <button class="btn btn-primary mt-2" @onclick="OpenCreateModal">
                                                    Add your first user
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @if (TotalCount > PageSize)
                        {
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item @(CurrentPage <= 1 ? "disabled" : "")">
                                        <button class="page-link" @onclick="PreviousPage">Previous</button>
                                    </li>
                                    @for (int i = 1; i <= TotalPages; i++)
                                    {
                                        var pageNum = i;
                                        <li class="page-item @(CurrentPage == pageNum ? "active" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                                        </li>
                                    }
                                    <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                                        <button class="page-link" @onclick="NextPage">Next</button>
                                    </li>
                                </ul>
                            </nav>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
@if (ShowModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas @(IsEditing ? "fa-edit" : "fa-plus") me-2"></i>
                        @(IsEditing ? "Edit User Profile" : "Create New User")
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseModal"></button>
                </div>
                <EditForm Model="CurrentUser" OnValidSubmit="SaveUser">
                    <DataAnnotationsValidator />
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(FormErrorMessage))
                        {
                            <div class="alert alert-danger">@FormErrorMessage</div>
                        }
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Full Name *</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.FullName" placeholder="John Doe" />
                                <ValidationMessage For="@(() => CurrentUser.FullName)" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.Email" placeholder="john@example.com" />
                                <ValidationMessage For="@(() => CurrentUser.Email)" />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">System Role *</label>
                                <InputSelect class="form-select" @bind-Value="CurrentUser.SystemRole">
                                    @foreach (var role in Enum.GetValues<SystemRoleDto>())
                                    {
                                        <option value="@role">@role</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stakeholder Type *</label>
                                <InputSelect class="form-select" @bind-Value="CurrentUser.StakeholderType">
                                    @foreach (var type in Enum.GetValues<StakeholderTypeDto>())
                                    {
                                        <option value="@type">@GetStakeholderLabel(type)</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Job Title</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.JobTitle" placeholder="Software Engineer" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.Department" placeholder="Engineering" />
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Phone</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.Phone" placeholder="+1 234 567 8900" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Country</label>
                                <InputSelect class="form-select" @bind-Value="CurrentUser.Country">
                                    <option value="">Select Country</option>
                                    @foreach (var country in CountryList)
                                    {
                                        <option value="@country">@country</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location</label>
                                <InputText class="form-control" @bind-Value="CurrentUser.Location" placeholder="City, Office" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Start Date</label>
                                <InputDate class="form-control" @bind-Value="CurrentUser.StartDate" />
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Bio</label>
                            <InputTextArea class="form-control" @bind-Value="CurrentUser.Bio" rows="2" placeholder="Brief biography..." />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Skills (comma-separated)</label>
                            <InputText class="form-control" @bind-Value="CurrentUser.Skills" placeholder="Python, Azure, Project Management" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button type="submit" class="btn btn-primary" disabled="@Saving">
                            @if (Saving)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            @(IsEditing ? "Update" : "Create")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

<!-- Details Modal -->
@if (ShowDetailsModal && SelectedUser != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user me-2"></i>User Profile Details
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Full Name:</strong> @SelectedUser.FullName</p>
                            <p><strong>Email:</strong> @SelectedUser.Email</p>
                            <p><strong>System Role:</strong> <span class="badge bg-@GetRoleColor(SelectedUser.SystemRole)">@SelectedUser.SystemRole</span></p>
                            <p><strong>Stakeholder Type:</strong> <span class="badge bg-info">@GetStakeholderLabel(SelectedUser.StakeholderType)</span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Job Title:</strong> @(SelectedUser.JobTitle ?? "N/A")</p>
                            <p><strong>Department:</strong> @(SelectedUser.Department ?? "N/A")</p>
                            <p><strong>Phone:</strong> @(SelectedUser.Phone ?? "N/A")</p>
                            <p><strong>Location:</strong> @(SelectedUser.Location ?? SelectedUser.Country ?? "N/A")</p>
                        </div>
                    </div>
                    <hr />
                    <p><strong>Bio:</strong></p>
                    <p>@(SelectedUser.Bio ?? "No bio provided")</p>
                    <hr />
                    <p><strong>Skills:</strong> @(SelectedUser.Skills ?? "None listed")</p>
                    <p><strong>Start Date:</strong> @(SelectedUser.StartDate?.ToString("yyyy-MM-dd") ?? "N/A")</p>
                    <p><strong>Profile Completed:</strong> @(SelectedUser.ProfileCompleted ? "Yes" : "No")</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                    <button type="button" class="btn btn-warning" @onclick="() => EditUser(SelectedUser)">
                        <i class="fas fa-edit me-1"></i>Edit
                    </button>
                </div>
            </div>
        </div>
    </div>
}
