@page "/approvals"
@layout PlatformLayout
@using DoganConsult.Web.Blazor.Services
@using Volo.Abp.Application.Dtos

<PageTitle>Approval Management</PageTitle>

<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1">My Pending</h6>
                            <h2 class="mb-0">@(Statistics?.MyPendingApprovals ?? 0)</h2>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1">Total Pending</h6>
                            <h2 class="mb-0">@(Statistics?.TotalPending ?? 0)</h2>
                        </div>
                        <i class="fas fa-hourglass-half fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1">Approved Today</h6>
                            <h2 class="mb-0">@(Statistics?.MyApprovedToday ?? 0)</h2>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-1">Avg. Time (hrs)</h6>
                            <h2 class="mb-0">@(Statistics?.AverageApprovalTimeHours.ToString("F1") ?? "N/A")</h2>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-3">
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "pending" ? "active" : "")" @onclick="@(() => SwitchTab("pending"))">
                <i class="fas fa-inbox me-1"></i> My Pending Approvals
                @if ((Statistics?.MyPendingApprovals ?? 0) > 0)
                {
                    <span class="badge bg-warning text-dark ms-1">@Statistics!.MyPendingApprovals</span>
                }
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "myrequests" ? "active" : "")" @onclick="@(() => SwitchTab("myrequests"))">
                <i class="fas fa-paper-plane me-1"></i> My Requests
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link @(ActiveTab == "all" ? "active" : "")" @onclick="@(() => SwitchTab("all"))">
                <i class="fas fa-list me-1"></i> All Approvals
            </button>
        </li>
    </ul>

    <!-- Main Content Card -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    @GetTabTitle()
                </h4>
                <button class="btn btn-outline-primary btn-sm" @onclick="RefreshData">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
            </div>
        </div>
        
        <div class="card-body">
            @if (Loading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading approval requests...</p>
                </div>
            }
            else if (ApprovalItems?.Any() != true)
            {
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No approval requests found.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th scope="col">Request #</th>
                                <th scope="col">Entity</th>
                                <th scope="col">Action</th>
                                <th scope="col">Requester</th>
                                <th scope="col">Priority</th>
                                <th scope="col">Status</th>
                                <th scope="col">Created</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in ApprovalItems)
                            {
                                <tr>
                                    <td><code>@item.RequestNumber</code></td>
                                    <td>
                                        <span class="badge bg-@GetEntityTypeColor(item.EntityType) me-1">
                                            @item.EntityType
                                        </span>
                                        <small>@item.EntityName</small>
                                    </td>
                                    <td>@item.RequestedAction</td>
                                    <td>@item.RequesterName</td>
                                    <td>
                                        <span class="badge bg-@GetPriorityColor(item.Priority)">
                                            @item.Priority
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-@GetStatusColor(item.Status)">
                                            @item.StatusDisplay
                                        </span>
                                        @if (item.IsExpired && item.Status == ApprovalStatus.Pending)
                                        {
                                            <span class="badge bg-danger ms-1">Expired!</span>
                                        }
                                    </td>
                                    <td>
                                        <small>@item.CreationTime.ToString("MMM dd, HH:mm")</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-info" @onclick="() => ViewDetails(item)" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            @if (item.Status == ApprovalStatus.Pending)
                                            {
                                                <button class="btn btn-sm btn-success" @onclick="() => OpenApproveModal(item)" title="Approve">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" @onclick="() => OpenRejectModal(item)" title="Reject">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav>
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(CurrentPage <= 1 ? "disabled" : "")">
                            <button class="page-link" @onclick="PreviousPage">Previous</button>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Page @CurrentPage of @TotalPages</span>
                        </li>
                        <li class="page-item @(CurrentPage >= TotalPages ? "disabled" : "")">
                            <button class="page-link" @onclick="NextPage">Next</button>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

<!-- Details Modal -->
@if (ShowDetailsModal && SelectedApproval != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-alt me-2"></i>Approval Details - @SelectedApproval.RequestNumber
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseDetailsModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl>
                                <dt>Request Number</dt>
                                <dd><code>@SelectedApproval.RequestNumber</code></dd>
                                
                                <dt>Entity Type</dt>
                                <dd><span class="badge bg-@GetEntityTypeColor(SelectedApproval.EntityType)">@SelectedApproval.EntityType</span></dd>
                                
                                <dt>Entity Name</dt>
                                <dd>@SelectedApproval.EntityName</dd>
                                
                                <dt>Requested Action</dt>
                                <dd>@SelectedApproval.RequestedAction</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl>
                                <dt>Status</dt>
                                <dd><span class="badge bg-@GetStatusColor(SelectedApproval.Status)">@SelectedApproval.StatusDisplay</span></dd>
                                
                                <dt>Priority</dt>
                                <dd><span class="badge bg-@GetPriorityColor(SelectedApproval.Priority)">@SelectedApproval.Priority</span></dd>
                                
                                <dt>Requester</dt>
                                <dd>@SelectedApproval.RequesterName</dd>
                                
                                <dt>Created</dt>
                                <dd>@SelectedApproval.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")</dd>
                            </dl>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(SelectedApproval.RequestReason))
                    {
                        <div class="mt-3">
                            <h6>Request Reason</h6>
                            <p class="bg-light p-2 rounded">@SelectedApproval.RequestReason</p>
                        </div>
                    }
                    
                    @if (SelectedApproval.ApprovedAt.HasValue)
                    {
                        <div class="mt-3 alert @(SelectedApproval.Status == ApprovalStatus.Approved ? "alert-success" : "alert-danger")">
                            <strong>@(SelectedApproval.Status == ApprovalStatus.Approved ? "Approved" : "Rejected")</strong> 
                            by @SelectedApproval.ApprovedByName on @SelectedApproval.ApprovedAt.Value.ToString("yyyy-MM-dd HH:mm")
                            @if (!string.IsNullOrEmpty(SelectedApproval.ApprovalComments))
                            {
                                <p class="mb-0 mt-2"><strong>Comments:</strong> @SelectedApproval.ApprovalComments</p>
                            }
                        </div>
                    }

                    <!-- History Section -->
                    @if (ApprovalHistory?.Any() == true)
                    {
                        <div class="mt-4">
                            <h6><i class="fas fa-history me-1"></i> History</h6>
                            <div class="timeline">
                                @foreach (var history in ApprovalHistory.OrderByDescending(h => h.CreationTime))
                                {
                                    <div class="card mb-2">
                                        <div class="card-body py-2">
                                            <div class="d-flex justify-content-between">
                                                <span>
                                                    <strong>@history.Action</strong> by @history.ActorName
                                                </span>
                                                <small class="text-muted">@history.CreationTime.ToString("MMM dd, HH:mm")</small>
                                            </div>
                                            @if (!string.IsNullOrEmpty(history.Comments))
                                            {
                                                <small class="text-muted">@history.Comments</small>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Approve/Reject Modal -->
@if (ShowActionModal && SelectedApproval != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header @(IsApproving ? "bg-success text-white" : "bg-danger text-white")">
                    <h5 class="modal-title">
                        <i class="fas @(IsApproving ? "fa-check" : "fa-times") me-2"></i>
                        @(IsApproving ? "Approve" : "Reject") Request
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CloseActionModal"></button>
                </div>
                <div class="modal-body">
                    <p>You are about to <strong>@(IsApproving ? "approve" : "reject")</strong> the following request:</p>
                    <ul>
                        <li><strong>Request #:</strong> @SelectedApproval.RequestNumber</li>
                        <li><strong>Entity:</strong> @SelectedApproval.EntityType - @SelectedApproval.EntityName</li>
                        <li><strong>Action:</strong> @SelectedApproval.RequestedAction</li>
                    </ul>
                    
                    <div class="mb-3">
                        <label for="comments" class="form-label">Comments (optional)</label>
                        <textarea class="form-control" id="comments" rows="3" @bind="ActionComments" 
                            placeholder="Add any comments about your decision..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseActionModal" disabled="@Processing">Cancel</button>
                    <button type="button" class="btn @(IsApproving ? "btn-success" : "btn-danger")" 
                        @onclick="ProcessAction" disabled="@Processing">
                        @if (Processing)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        @(IsApproving ? "Approve" : "Reject")
                    </button>
                </div>
            </div>
        </div>
    </div>
}
